#!/usr/bin/env bash
# WordprocessingML Automated Cleanup Script
# Performs automated cleanup tasks from the cleanup checklist
# Usage: cleanup-wordml <expanded-template-dir>

set -euo pipefail

# Check if directory argument is provided
if [ $# -eq 0 ]; then
    echo "Usage: cleanup-wordml <expanded-template-dir>"
    echo ""
    echo "Example:"
    echo "  cleanup-wordml /path/to/template_expanded"
    echo ""
    echo "This script performs automated cleanup on unpacked WordprocessingML files:"
    echo "  - Removes RSID attributes and blocks"
    echo "  - Cleans up Normal style"
    echo "  - Removes noProof, iCs, szCs, bCs elements"
    echo "  - Removes bidirectional language settings"
    echo "  - Cleans up empty rPr and pPr blocks"
    exit 1
fi

TEMPLATE_DIR="$1"

# Validate directory exists
if [ ! -d "$TEMPLATE_DIR" ]; then
    echo "Error: Directory not found: $TEMPLATE_DIR"
    exit 1
fi

# Validate it's a word template directory
if [ ! -d "$TEMPLATE_DIR/word" ]; then
    echo "Error: Not a valid unpacked template: missing 'word' directory"
    exit 1
fi

STYLES_FILE="$TEMPLATE_DIR/word/styles.xml"
SETTINGS_FILE="$TEMPLATE_DIR/word/settings.xml"

if [ ! -f "$STYLES_FILE" ]; then
    echo "Error: styles.xml not found at: $STYLES_FILE"
    exit 1
fi

echo "WordprocessingML Automated Cleanup"
echo "Target: $TEMPLATE_DIR"
echo ""

# Optional: Remove unnecessary files (uncomment to enable)
# Uncomment the sections below to remove files you don't need

# Remove comments files
if [ -f "$TEMPLATE_DIR/word/comments.xml" ]; then
    echo "Removing comments.xml..."
    rm -f "$TEMPLATE_DIR/word/comments.xml"
    # Remove from document.xml.rels
    RELS_FILE="$TEMPLATE_DIR/word/_rels/document.xml.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Type="[^"]*\/comments"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    # Remove from [Content_Types].xml
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/word\/comments\.xml"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ comments.xml removed"
fi

# Remove commentsExtended.xml
if [ -f "$TEMPLATE_DIR/word/commentsExtended.xml" ]; then
    echo "Removing commentsExtended.xml..."
    rm -f "$TEMPLATE_DIR/word/commentsExtended.xml"
    RELS_FILE="$TEMPLATE_DIR/word/_rels/document.xml.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Type="[^"]*\/commentsExtended"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/word\/commentsExtended\.xml"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ commentsExtended.xml removed"
fi

# Remove commentsExtensible.xml
if [ -f "$TEMPLATE_DIR/word/commentsExtensible.xml" ]; then
    echo "Removing commentsExtensible.xml..."
    rm -f "$TEMPLATE_DIR/word/commentsExtensible.xml"
    RELS_FILE="$TEMPLATE_DIR/word/_rels/document.xml.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Type="[^"]*\/commentsExtensible"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/word\/commentsExtensible\.xml"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ commentsExtensible.xml removed"
fi

# Remove commentsIds.xml
if [ -f "$TEMPLATE_DIR/word/commentsIds.xml" ]; then
    echo "Removing commentsIds.xml..."
    rm -f "$TEMPLATE_DIR/word/commentsIds.xml"
    RELS_FILE="$TEMPLATE_DIR/word/_rels/document.xml.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Type="[^"]*\/commentsIds"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/word\/commentsIds\.xml"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ commentsIds.xml removed"
fi

# Remove endnotes.xml
if [ -f "$TEMPLATE_DIR/word/endnotes.xml" ]; then
    echo "Removing endnotes.xml..."
    rm -f "$TEMPLATE_DIR/word/endnotes.xml"
    RELS_FILE="$TEMPLATE_DIR/word/_rels/document.xml.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Type="[^"]*\/endnotes"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/word\/endnotes\.xml"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ endnotes.xml removed"
fi

# Remove people.xml
if [ -f "$TEMPLATE_DIR/word/people.xml" ]; then
    echo "Removing people.xml..."
    rm -f "$TEMPLATE_DIR/word/people.xml"
    RELS_FILE="$TEMPLATE_DIR/word/_rels/document.xml.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Type="[^"]*\/people"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/word\/people\.xml"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ people.xml removed"
fi

# Remove glossary folder
if [ -d "$TEMPLATE_DIR/word/glossary" ]; then
    echo "Removing glossary folder..."
    rm -rf "$TEMPLATE_DIR/word/glossary"
    RELS_FILE="$TEMPLATE_DIR/word/_rels/document.xml.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Type="[^"]*\/glossaryDocument"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/word\/glossary\/[^"]*"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ glossary folder removed"
fi

# Remove customXml folder
if [ -d "$TEMPLATE_DIR/customXml" ]; then
    echo "Removing customXml folder..."
    rm -rf "$TEMPLATE_DIR/customXml"
    # Remove from _rels/.rels
    RELS_FILE="$TEMPLATE_DIR/_rels/.rels"
    if [ -f "$RELS_FILE" ]; then
        perl -i -0pe 's/<Relationship[^>]*Target="customXml\/[^"]*"[^>]*\/?>\s*\n//g' "$RELS_FILE"
    fi
    # Remove from [Content_Types].xml
    CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
    if [ -f "$CONTENT_TYPES" ]; then
        perl -i -0pe 's/<Override[^>]*PartName="\/customXml\/[^"]*"[^>]*\/?>\s*\n//g' "$CONTENT_TYPES"
    fi
    echo "✓ customXml folder removed"
fi

echo ""

# 1. Remove RSID attributes from all XML files
echo "Removing RSID attributes..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -pe 's/\s+w:rsid[A-Z][a-zA-Z]*="[0-9A-F]+"//g' {} \;
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -pe 's/\s+rsid[A-Z][a-zA-Z]*="[0-9A-F]+"//g' {} \;
# Clean up orphaned whitespace and newlines before closing brackets (multiline mode)
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -0pe 's/\s*\n\s*\n\s*>/>/gs' {} \;
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -0pe 's/\s*\n>/>/gs' {} \;
echo "✓ RSID attributes removed from all files"

# 2. Remove <w:rsid> elements (individual rsid entries)
echo "Removing individual RSID elements..."
perl -i -pe 's/^\s*<w:rsid\s+w:val="[0-9A-F]+"\s*\/>\s*\n//g' "$STYLES_FILE"
echo "✓ Individual RSID elements removed"

# 3. Remove entire <w:rsids> block from settings.xml
if [ -f "$SETTINGS_FILE" ]; then
    echo "Removing RSID block from settings.xml..."
    perl -i -0pe 's/<w:rsids>.*?<\/w:rsids>\s*\n//gs' "$SETTINGS_FILE"
    echo "✓ RSID block removed from settings.xml"
fi

# 4. Remove <w:noProof /> elements from all XML files
echo "Removing noProof elements..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -pe 's/^\s*<w:noProof\s*\/>\s*\n//g' {} \;
echo "✓ noProof elements removed from all files"

# 5. Remove <w:iCs /> elements (italic for Complex Scripts)
echo "Removing iCs elements..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -pe 's/^\s*<w:iCs\s*\/>\s*\n//g' {} \;
echo "✓ iCs elements removed from all files"

# 6. Remove <w:bCs /> elements (bold for Complex Scripts)
echo "Removing bCs elements..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -pe 's/^\s*<w:bCs\s*\/>\s*\n//g' {} \;
echo "✓ bCs elements removed from all files"

# 7. Remove <w:szCs /> elements (size for Complex Scripts)
echo "Removing szCs elements..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -pe 's/^\s*<w:szCs\s+w:val="[^"]+"\s*\/>\s*\n//g' {} \;
echo "✓ szCs elements removed from all files"

# 8. Remove w:bidi language attributes
echo "Removing bidi language attributes..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -pe 's/\s+w:bidi="[^"]+"//g' {} \;
echo "✓ Bidi language attributes removed from all files"

# 9. Clean up empty <w:rPr></w:rPr> blocks
echo "Cleaning up empty rPr blocks..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -0pe 's/<w:rPr>\s*<\/w:rPr>\s*\n//gs' {} \;
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -0pe 's/<w:rPr\/>\s*\n//g' {} \;
echo "✓ Empty rPr blocks removed from all files"

# 10. Clean up empty <w:pPr></w:pPr> blocks
echo "Cleaning up empty pPr blocks..."
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -0pe 's/<w:pPr>\s*<\/w:pPr>\s*\n//gs' {} \;
find "$TEMPLATE_DIR/word" -name "*.xml" -type f -exec perl -i -0pe 's/<w:pPr\/>\s*\n//g' {} \;
echo "✓ Empty pPr blocks removed from all files"

# 11. Remove revision tracking from settings.xml
if [ -f "$SETTINGS_FILE" ]; then
    echo "Removing revision tracking settings..."
    perl -i -pe 's/^\s*<w:trackRevisions\s*\/>\s*\n//g' "$SETTINGS_FILE"
    perl -i -pe 's/^\s*<w:trackFormatting\s*\/>\s*\n//g' "$SETTINGS_FILE"
    echo "✓ Revision tracking settings removed"
fi

# 13. Remove comment references from document.xml
DOCUMENT_FILE="$TEMPLATE_DIR/word/document.xml"
if [ -f "$DOCUMENT_FILE" ]; then
    echo "Removing comment references from document.xml..."
    perl -i -0pe 's/<w:commentRangeStart[^>]*\/?>//gs' "$DOCUMENT_FILE"
    perl -i -0pe 's/<w:commentRangeEnd[^>]*\/?>//gs' "$DOCUMENT_FILE"
    perl -i -0pe 's/<w:commentReference[^>]*\/?>//gs' "$DOCUMENT_FILE"
    echo "✓ Comment references removed from document.xml"
    
    # Validate document.xml without modifying it (don't compact or reformat)
    echo "Validating document.xml syntax..."
    if xmllint --noout "$DOCUMENT_FILE" 2>/dev/null; then
        echo "✓ document.xml is valid"
    else
        echo "  Warning: document.xml has XML syntax errors"
    fi
fi

# 14. Remove endnote references from settings.xml
if [ -f "$SETTINGS_FILE" ]; then
    echo "Removing endnote settings..."
    perl -i -0pe 's/<w:endnotePr>.*?<\/w:endnotePr>//gs' "$SETTINGS_FILE"
    perl -i -0pe 's/<w:footnotePr>.*?<\/w:footnotePr>//gs' "$SETTINGS_FILE"
    echo "✓ Endnote and footnote settings removed"
fi

# 15. Remove styles with "delete" in the name from styles.xml
if [ -f "$STYLES_FILE" ]; then
    echo "Removing styles with 'delete' in name..."
    # Remove entire style blocks where styleId or name contains "delete" (case insensitive)
    perl -i -0pe 's/<w:style\s+[^>]*w:styleId="[^"]*[Dd][Ee][Ll][Ee][Tt][Ee][^"]*"[^>]*>.*?<\/w:style>\s*\n//gs' "$STYLES_FILE"
    perl -i -0pe 's/<w:style\s+[^>]*>\s*<w:name\s+w:val="[^"]*[Dd][Ee][Ll][Ee][Tt][Ee][^"]*"[^>]*\/>.*?<\/w:style>\s*\n//gs' "$STYLES_FILE"
    echo "✓ Styles with 'delete' removed"
fi

# 16. Remove numbering definitions with "delete" in the name from numbering.xml
NUMBERING_FILE="$TEMPLATE_DIR/word/numbering.xml"
if [ -f "$NUMBERING_FILE" ]; then
    echo "Removing numbering with 'delete' in name..."
    # Remove abstractNum blocks where name contains "delete"
    perl -i -0pe 's/<w:abstractNum\s+[^>]*>(?:(?!<\/w:abstractNum>).)*<w:name\s+w:val="[^"]*[Dd][Ee][Ll][Ee][Tt][Ee][^"]*"[^>]*\/>.*?<\/w:abstractNum>\s*\n//gs' "$NUMBERING_FILE"
    # Remove abstractNum blocks where styleLink contains "delete" (case insensitive)
    perl -i -0pe 's/<w:abstractNum\s+[^>]*>(?:(?!<\/w:abstractNum>).)*<w:styleLink\s+w:val="[^"]*[Dd][Ee][Ll][Ee][Tt][Ee][^"]*"[^>]*\/>.*?<\/w:abstractNum>\s*\n//gs' "$NUMBERING_FILE"
    # Remove num blocks that reference deleted abstractNum
    echo "✓ Numbering and abstractNum with 'delete' removed"
fi

# 12. Remove linked heading character styles
echo "Removing linked heading character styles..."
# Remove the link elements from paragraph styles
perl -i -pe 's/^\s*<w:link\s+w:val="Heading[0-9]Char"\s*\/>\s*\n//g' "$STYLES_FILE"
# Remove character style definitions for headings
perl -i -0pe 's/<w:style\s+w:type="character"[^>]*w:styleId="Heading[0-9]Char"[^>]*>.*?<\/w:style>\s*\n//gs' "$STYLES_FILE"
echo "✓ Linked heading character styles removed"

echo ""

# Final cleanup of relationship files and [Content_Types].xml
DOC_RELS="$TEMPLATE_DIR/word/_rels/document.xml.rels"
if [ -f "$DOC_RELS" ]; then
    echo "Cleaning up document.xml.rels..."
    # Remove relationships to deleted files
    perl -i -0pe 's/<Relationship[^>]*Target="comments\.xml"[^>]*\/?>//gs' "$DOC_RELS"
    perl -i -0pe 's/<Relationship[^>]*Target="commentsExtended\.xml"[^>]*\/?>//gs' "$DOC_RELS"
    perl -i -0pe 's/<Relationship[^>]*Target="commentsExtensible\.xml"[^>]*\/?>//gs' "$DOC_RELS"
    perl -i -0pe 's/<Relationship[^>]*Target="commentsIds\.xml"[^>]*\/?>//gs' "$DOC_RELS"
    perl -i -0pe 's/<Relationship[^>]*Target="endnotes\.xml"[^>]*\/?>//gs' "$DOC_RELS"
    perl -i -0pe 's/<Relationship[^>]*Target="people\.xml"[^>]*\/?>//gs' "$DOC_RELS"
    perl -i -0pe 's/<Relationship[^>]*Target="glossary\/document\.xml"[^>]*\/?>//gs' "$DOC_RELS"
    perl -i -0pe 's/<Relationship[^>]*Target="\.\.\/customXml\/[^"]*"[^>]*\/?>//gs' "$DOC_RELS"
    echo "✓ document.xml.rels cleaned"
fi

CONTENT_TYPES="$TEMPLATE_DIR/[Content_Types].xml"
if [ -f "$CONTENT_TYPES" ]; then
    echo "Cleaning up [Content_Types].xml..."
    # Remove any references to deleted files
    perl -i -0pe 's/<Override[^>]*PartName="\/word\/comments\.xml"[^>]*\/?>//gs' "$CONTENT_TYPES"
    perl -i -0pe 's/<Override[^>]*PartName="\/word\/commentsExtended\.xml"[^>]*\/?>//gs' "$CONTENT_TYPES"
    perl -i -0pe 's/<Override[^>]*PartName="\/word\/commentsExtensible\.xml"[^>]*\/?>//gs' "$CONTENT_TYPES"
    perl -i -0pe 's/<Override[^>]*PartName="\/word\/commentsIds\.xml"[^>]*\/?>//gs' "$CONTENT_TYPES"
    perl -i -0pe 's/<Override[^>]*PartName="\/word\/endnotes\.xml"[^>]*\/?>//gs' "$CONTENT_TYPES"
    perl -i -0pe 's/<Override[^>]*PartName="\/word\/people\.xml"[^>]*\/?>//gs' "$CONTENT_TYPES"
    perl -i -0pe 's/<Override[^>]*PartName="\/word\/glossary\/[^"]*"[^>]*\/?>//gs' "$CONTENT_TYPES"
    perl -i -0pe 's/<Override[^>]*PartName="\/customXml\/[^"]*"[^>]*\/?>//gs' "$CONTENT_TYPES"
    echo "✓ [Content_Types].xml cleaned"
fi

echo ""

# Validate and fix XML syntax
echo "Validating and fixing XML syntax..."
XML_FIXED=0

# Process [Content_Types].xml
if [ -f "$CONTENT_TYPES" ]; then
    if xmllint --format "$CONTENT_TYPES" > "$CONTENT_TYPES.tmp" 2>/dev/null; then
        mv "$CONTENT_TYPES.tmp" "$CONTENT_TYPES"
        XML_FIXED=$((XML_FIXED + 1))
    else
        rm -f "$CONTENT_TYPES.tmp"
        echo "  Warning: Could not validate/fix [Content_Types].xml"
    fi
fi

# Process relationship files
for rels_file in $(find "$TEMPLATE_DIR" -name "*.rels" -type f); do
    if xmllint --format "$rels_file" > "$rels_file.tmp" 2>/dev/null; then
        mv "$rels_file.tmp" "$rels_file"
        XML_FIXED=$((XML_FIXED + 1))
    else
        rm -f "$rels_file.tmp"
        echo "  Warning: Could not validate/fix $rels_file"
    fi
done

# Process all XML files in word directory
for xml_file in $(find "$TEMPLATE_DIR/word" -name "*.xml" -type f); do
    # Use xmllint to validate and reformat XML
    # For document.xml, only validate (don't reformat to preserve spacing in text elements)
    if [[ "$xml_file" == *"/document.xml" ]]; then
        if xmllint --noout "$xml_file" 2>/dev/null; then
            XML_FIXED=$((XML_FIXED + 1))
        else
            echo "  Warning: document.xml has XML syntax errors"
        fi
    else
        if xmllint --format "$xml_file" > "$xml_file.tmp" 2>/dev/null; then
            mv "$xml_file.tmp" "$xml_file"
            XML_FIXED=$((XML_FIXED + 1))
        else
            rm -f "$xml_file.tmp"
            echo "  Warning: Could not validate/fix $xml_file"
        fi
    fi
done
echo "✓ XML syntax validated and fixed ($XML_FIXED files processed)"

echo ""
echo "✓ Cleanup completed"
echo ""
echo "Next steps:"
echo "  1. Review the cleaned files manually"
echo "  2. Complete manual validation checklist items"
echo "  3. Pack and test the template:"
echo "     pack $TEMPLATE_DIR template.dotm"
echo ""
