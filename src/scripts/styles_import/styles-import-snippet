#!/usr/bin/env bash
# Import Styles From Snippet Script
# Usage: styles-import-snippet <target-doc> <snippet-file> [snippet-id]

set -euo pipefail

# Convert Windows path to Unix path if needed (for Git Bash on Windows)
normalize_path() {
    local path="$1"
    if [[ "$path" =~ ^[A-Za-z]:\\ ]]; then
        # Convert C:\path to /c/path format
        local drive_letter=$(echo "${path:0:1}" | tr '[:upper:]' '[:lower:]')
        local rest_of_path="${path:3}"
        rest_of_path="${rest_of_path//\\//}"
        echo "/$drive_letter/$rest_of_path"
    else
        echo "$path"
    fi
}

if [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]] 2>/dev/null; then
    echo "Usage: styles-import-snippet <target-doc> <snippet-file> [snippet-id]"
    echo ""
    echo "Import styles from an XML snippet file to target document"
    echo ""
    echo "Arguments:"
    echo "  target-doc    - Document that will receive styles (will be modified)"
    echo "  snippet-file  - XML file containing style snippets"
    echo "  snippet-id    - ID of the snippet to use (e.g., 'listStylesDefault')"
    echo ""
    echo "Examples:"
    echo "  styles-import-snippet target.docx core/partials/styles/list-styles.xml listStylesDefault"
    echo "  styles-import-snippet myDoc.docm core/partials/styles/toc-styles.xml tocStylesDefault"
    exit 0
fi

if [ $# -lt 2 ]; then
    echo "Usage: styles-import-snippet <target-doc> <snippet-file> [snippet-id]"
    echo "Run 'styles-import-snippet --help' for more information"
    exit 1
fi

# Get the script directory to find the project
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"

# Normalize paths
TARGET_DOC="$(normalize_path "$1")"
SNIPPET_FILE="$(normalize_path "$2")"
SNIPPET_ID="${3:-}"

# Run the dotnet command from the project file
if [ -n "$SNIPPET_ID" ]; then
    dotnet run --project "$PROJECT_ROOT/src/OpenXmlApp/OpenXmlApp.csproj" -- styles-import-snippet "$TARGET_DOC" "$SNIPPET_FILE" "$SNIPPET_ID"
else
    dotnet run --project "$PROJECT_ROOT/src/OpenXmlApp/OpenXmlApp.csproj" -- styles-import-snippet "$TARGET_DOC" "$SNIPPET_FILE"
fi
