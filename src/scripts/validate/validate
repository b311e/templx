#!/usr/bin/env bash
# OOXML Validation Script
# Usage: validate-ooxml <file-path>
# Validates Office Open XML documents and saves a report to a "reports" folder
# in the same directory as the input file.

set -euo pipefail

if [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]] 2>/dev/null; then
    echo "Usage: validate <file-path>"
    echo ""
    echo "Validate OpenXML documents against ECMA-376 schema"
    echo ""
    echo "Arguments:"
    echo "  file-path  - Path to OpenXML file to validate"
    echo ""
    echo "Supported file types:"
    echo "  Word: .docx, .docm, .dotx, .dotm"
    echo "  Excel: .xlsx, .xlsm, .xltx, .xltm"
    echo "  PowerPoint: .pptx, .pptm, .potx, .potm"
    echo ""
    echo "Output:"
    echo "  Validation report saved to <file-directory>/reports/<filename>-validation-<timestamp>.txt"
    echo ""
    echo "Examples:"
    echo "  validate builds/jbc/workspace/jbcNormal/out/jbcNormal.dotm"
    echo "  validate builds/jbc/templates/jbcMemo/out/jbcMemo.dotx"
    exit 0
fi

if [ $# -lt 1 ]; then
    echo "Usage: validate <file-path>"
    echo "Run 'validate --help' for more information"
    exit 1
fi

# Get the script directory to find the project
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
OPENXML_APP="$PROJECT_ROOT/src/OpenXmlApp/bin/Debug/net8.0/OpenXmlApp.exe"

FILE_PATH="$1"

# Check if file exists
if [ ! -f "$FILE_PATH" ]; then
    echo "Error: File not found: $FILE_PATH"
    exit 1
fi

# Check if OpenXmlApp is built
if [ ! -f "$OPENXML_APP" ]; then
    echo "OpenXmlApp not found. Building..."
    cd "$PROJECT_ROOT/src/OpenXmlApp"
    dotnet build --configuration Debug
    cd - > /dev/null
fi

# Run validation
"$OPENXML_APP" validate "$FILE_PATH"
