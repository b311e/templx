#!/usr/bin/env bash
# Manifest Generator for COGA Template Manager


# Hyphenated command support only:
#   manifest-generate-core
#   manifest-generate-partials
#   manifest-generate-<agency>
#   manifest-validate
#   manifest-list

script_base=$(basename "$0")
case "$script_base" in
    manifest-generate-core)
        generate_manifest core
        exit $?
        ;;
    manifest-generate-partials)
        python3 "$SCRIPT_DIR/manifest-generate-partials.py" "${@:2}"
        exit $?
        ;;
    manifest-generate-*)
        agency="${script_base#manifest-generate-}"
        generate_manifest "$agency"
        exit $?
        ;;
    manifest-validate)
        validate_manifest
        exit $?
        ;;
    manifest-list)
        list_templates
        exit $?
        ;;
esac


SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"

generate_manifest() {
    # Entry point: manifest generate <agency> (or pass 'core' to generate core manifest)
    local agency="$1"
    if [[ "$agency" == "core" ]]; then
        generate_core_manifest
        return $?
    fi

    if [[ -z "$agency" ]]; then
        echo "Usage: manifest generate agency <agency>"
        return 1
    fi



    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local agency_dir="$PROJECT_ROOT/builds/$agency"
    local manifests_dir="$agency_dir/manifests"
    local manifest_file="$manifests_dir/manifest.json"


    if [[ ! -d "$agency_dir" ]]; then
        echo "Error: Agency directory not found: $agency_dir"
        return 1
    fi

    echo "Generating manifest for agency: $agency"
    echo "Scanning directory: $agency_dir"
    echo "Updating timestamp: $timestamp"

    # ensure manifests directory exists
    templates_json=""
    workspace_json=""
    first_entry_templates=true
    first_entry_workspace=true


# Helper to process a parent folder (templates or workspace)
process_templates_dir() {
    local parent_dir="$1"
    local is_workspace="$2"
    for template_dir in "$parent_dir"/*; do
        [[ ! -d "$template_dir" ]] && continue
        key=$(basename "$template_dir")
        out_dir="$template_dir/out"
        [[ ! -d "$out_dir" ]] && continue
        for template_file in "$out_dir"/*.dotm "$out_dir"/*.dotx "$out_dir"/*.xltx; do
            [[ ! -f "$template_file" ]] && continue
            rel_path="${template_file#$PROJECT_ROOT/}"
            file_name=$(basename "$template_file")
            ext=".${file_name##*.}"
            name="$key"
            type="word-doc-template"
            [[ "$ext" == ".xltx" ]] && type="excel-book-template"
            status=$(grep -A 10 "\"$key\"" "$manifest_file" | grep '"status"' | head -n1 | sed 's/.*"status": *"\([^"]*\)".*/\1/')
            [[ -z "$status" ]] && status="active"
            entry="        \"$key\": {\n          \"name\": \"$name\",\n          \"type\": \"$type\",\n          \"extension\": \"$ext\",\n          \"src\": \"$rel_path\",\n          \"status\": \"$status\"\n        }"
            if [[ "$is_workspace" == "true" ]]; then
                if $first_entry_workspace; then
                    workspace_json="$entry"
                    first_entry_workspace=false
                else
                    workspace_json="$workspace_json,\n$entry"
                fi
            else
                if $first_entry_templates; then
                    templates_json="$entry"
                    first_entry_templates=false
                else
                    templates_json="$templates_json,\n$entry"
                fi
            fi
            echo "  Found: $rel_path"
            break
        done
    done
}

    process_templates_dir "$agency_dir/templates" false
    process_templates_dir "$agency_dir/workspace" true

    # Replace the templates.templates and workspace.templates sections in manifest.json
    awk -v tblock="$templates_json" -v wblock="$workspace_json" '
        BEGIN {in_templates=0; in_templates_block=0; in_workspace=0; in_workspace_block=0}
        /"templates" *: *{/ && !in_templates {in_templates=1; print; next}
        in_templates && /"templates" *: *{/ {in_templates_block=1; print "      \"templates\": {"; print tblock; print "      }"; next}
        in_templates_block && /}/ {in_templates=0; in_templates_block=0; print; next}
        /"workspace" *: *{/ && !in_workspace {in_workspace=1; print; next}
        in_workspace && /"templates" *: *{/ {in_workspace_block=1; print "      \"templates\": {"; print wblock; print "      }"; next}
        in_workspace_block && /}/ {in_workspace=0; in_workspace_block=0; print; next}
        !in_templates_block && !in_workspace_block {print}
    ' "$manifest_file" > "$manifest_file.tmp" && mv "$manifest_file.tmp" "$manifest_file"
    echo "✓ Templates and workspace sections updated in manifest."

    echo ""
    echo "Template Discovery:"
    # Build new templates JSON entries
    templates_json=""
    first_entry=true
    while IFS= read -r template; do
        rel_path="${template#$PROJECT_ROOT/}"
        dir_name=$(basename "$(dirname "$template")")
        file_name=$(basename "$template")
        ext=".${file_name##*.}"
        key="$dir_name"
        name="$dir_name"
        type="word-doc-template"
        [[ "$ext" == ".xltx" ]] && type="excel-book-template"

        # Try to extract status from existing manifest
        status=$(grep -A 10 "\"$key\"" "$manifest_file" | grep '"status"' | head -n1 | sed 's/.*"status": *"\([^"]*\)".*/\1/')
        [[ -z "$status" ]] && status="active"

        entry="    \"$key\": {\n      \"name\": \"$name\",\n      \"type\": \"$type\",\n      \"extension\": \"$ext\",\n      \"src\": \"$rel_path\",\n      \"status\": \"$status\"\n    }"
        if $first_entry; then
            templates_json="$entry"
            first_entry=false
        else
            templates_json="$templates_json,\n$entry"
        fi
        echo "  Found: $rel_path"
    done < <(find "$agency_dir/templates" -type f \( -name "*.xltx" -o -name "*.dotx" -o -name "*.dotm" \))

    # Replace the templates.templates section in manifest.json
    if [[ -n "$templates_json" ]]; then
        awk -v newblock="$templates_json" '
            BEGIN {in_templates=0; in_templates_block=0}
            /"templates" *: *{/ && !in_templates {in_templates=1; print; next}
            in_templates && /"templates" *: *{/ {in_templates_block=1; print "      \"templates\": {"; print newblock; print "      }"; next}
            in_templates_block && /}/ {in_templates=0; in_templates_block=0; print; next}
            !in_templates_block {print}
        ' "$manifest_file" > "$manifest_file.tmp" && mv "$manifest_file.tmp" "$manifest_file"
        echo "✓ Templates section updated in manifest."
    else
        echo "No templates found to add."
    fi

    echo ""
    echo " Manifest updated: $manifest_file"
}

# The `manifest generate partials` action calls the canonical Python generators below.

generate_core_manifest() {
    local core_dir="$PROJECT_ROOT/core"
    local manifests_dir="$core_dir/manifests"
    local manifest_file="$manifests_dir/manifest.json"
    mkdir -p "$manifests_dir"
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    if [[ ! -d "$core_dir" ]]; then
        echo "Error: Core directory not found: $core_dir"
        return 1
    fi
    
    echo "Generating core manifest"
    echo "Scanning directory: $core_dir"
    echo "Manifest file: $manifest_file"
    
    # Initialize category arrays
    local base_normal=()
    local base_theme=()
    local base_sheet=()
    local base_book=()
    local base_colors=()
    local base_fonts=()
    local base_officeUI=()
    local partials_styles=()
    local partials_numbering=()
    
    # Collect all XML files in core/
    while IFS= read -r -d '' file; do
        local rel_path="${file#$PROJECT_ROOT/}"
        local filename=$(basename "$file" .xml)
        local category=""
        local subcategory=""
        
        # Map path to category.subcategory
        if [[ "$rel_path" == core/base/workspace/normal/* ]]; then
            category="base"
            subcategory="normal"
        elif [[ "$rel_path" == core/base/workspace/theme/* ]]; then
            category="base"
            subcategory="theme"
        elif [[ "$rel_path" == core/base/workspace/sheet/* ]]; then
            category="base"
            subcategory="sheet"
        elif [[ "$rel_path" == core/base/workspace/book/* ]]; then
            category="base"
            subcategory="book"
        elif [[ "$rel_path" == core/base/workspace/colors/* ]]; then
            category="base"
            subcategory="colors"
        elif [[ "$rel_path" == core/base/workspace/fonts/* ]]; then
            category="base"
            subcategory="fonts"
        elif [[ "$rel_path" == core/base/workspace/officeUI/* ]]; then
            category="base"
            subcategory="officeUI"
        elif [[ "$rel_path" == core/partials/styles/* ]]; then
            category="partials"
            subcategory="styles"
        elif [[ "$rel_path" == core/partials/numbering/* ]]; then
            category="partials"
            subcategory="numbering"
        else
            # Skip unknown paths
            continue
        fi
        
        local component="{\"id\": \"$filename\", \"path\": \"$rel_path\", \"status\": \"active\"}"
        
        # Add to appropriate array
        case "$category.$subcategory" in
            base.normal) base_normal+=("$component") ;;
            base.theme) base_theme+=("$component") ;;
            base.sheet) base_sheet+=("$component") ;;
            base.book) base_book+=("$component") ;;
            base.colors) base_colors+=("$component") ;;
            base.fonts) base_fonts+=("$component") ;;
            base.officeUI) base_officeUI+=("$component") ;;
            partials.styles) partials_styles+=("$component") ;;
            partials.numbering) partials_numbering+=("$component") ;;
        esac
    done < <(find "$core_dir" -name "*.xml" -print0)
    
    # Function to build JSON array from array
    build_array() {
        local arr=("$@")
        local json=""
        local first=true
        for item in "${arr[@]}"; do
            if $first; then
                first=false
            else
                json+=",\n        "
            fi
            json+="$item"
        done
        echo -e "$json"
    }
    
    # Build JSON
    local json="{\n  \"generated\": \"$timestamp\",\n  \"core\": {\n    \"base\": {\n"
    json+="      \"normal\": [\n        $(build_array "${base_normal[@]}")\n      ],\n"
    json+="      \"theme\": [\n        $(build_array "${base_theme[@]}")\n      ],\n"
    json+="      \"sheet\": [\n        $(build_array "${base_sheet[@]}")\n      ],\n"
    json+="      \"book\": [\n        $(build_array "${base_book[@]}")\n      ],\n"
    json+="      \"colors\": [\n        $(build_array "${base_colors[@]}")\n      ],\n"
    json+="      \"fonts\": [\n        $(build_array "${base_fonts[@]}")\n      ],\n"
    json+="      \"officeUI\": [\n        $(build_array "${base_officeUI[@]}")\n      ]\n"
    json+="    },\n    \"partials\": {\n"
    json+="      \"styles\": [\n        $(build_array "${partials_styles[@]}")\n      ],\n"
    json+="      \"numbering\": [\n        $(build_array "${partials_numbering[@]}")\n      ]\n"
    json+="    }\n  }\n}"
    

    # Write to file
    echo -e "$json" > "$manifest_file"
    
    local total=$(( ${#base_normal[@]} + ${#base_theme[@]} + ${#base_sheet[@]} + ${#base_book[@]} + ${#base_colors[@]} + ${#base_fonts[@]} + ${#base_officeUI[@]} + ${#partials_styles[@]} + ${#partials_numbering[@]} ))
    echo "✓ Core manifest generated: $manifest_file"
    echo "  Found $total components across categories"
}

generate_all() {
    echo "Generating all agency manifests under $PROJECT_ROOT/builds"
    for d in "$PROJECT_ROOT/builds"/*; do
        if [[ -d "$d" ]]; then
            agency=$(basename "$d")
            # skip non-agency entries that are not directories
            if [[ "$agency" == "manifests" || "$agency" == "tmp" ]]; then
                continue
            fi
            echo "--- Generating for agency: $agency"
            generate_manifest "$agency"
        fi
    done

    echo "--- Generating builds-level partials manifest"

}


update_template_status() {
    local agency="$1"
    local template="$2" 
    local status="$3"
    
    if [[ -z "$agency" || -z "$template" || -z "$status" ]]; then
        echo "Usage: manifest update-status <agency> <template> <status>"
        echo "Status options: active, planned, deprecated, testing"
        return 1
    fi
    
    local manifests_dir="$PROJECT_ROOT/builds/$agency/manifests"
    local legacy_manifest="$PROJECT_ROOT/builds/$agency/manifest.json"
    local manifest_file="$manifests_dir/manifest.json"

    mkdir -p "$manifests_dir"
    if [[ -f "$legacy_manifest" && ! -f "$manifest_file" ]]; then
        mv "$legacy_manifest" "$manifest_file"
    fi
    
    if [[ ! -f "$manifest_file" ]]; then
        echo "Error: Manifest not found: $manifest_file"
        return 1
    fi
    
    # Create backup
    cp "$manifest_file" "$manifest_file.backup"
    
    # Use sed to update the status
    sed -i "/$template/,/status/s/\"status\": \"[^\"]*\"/\"status\": \"$status\"/" "$manifest_file"
    
    echo "✓ Updated $template status to '$status' in $agency manifest"
    echo "✓ Backup created: $manifest_file.backup"
}

add_new_template() {
    local agency="$1"
    local template="$2"
    local type="$3"
    
    if [[ -z "$agency" || -z "$template" || -z "$type" ]]; then
        echo "Usage: manifest add-template <agency> <template> <type>"
        echo "Types: excel-book-template, excel-sheet-template, word-doc-template"
        return 1
    fi
    
    echo "To add a new template '$template' to agency '$agency':"
    echo "1. Edit builds/$agency/manifests/manifest.json"
    echo "2. Add template entry in appropriate category"
    echo "3. Run: manifest generate $agency"
    echo ""
    echo "Template structure needed:"
    echo "  builds/$agency/workspace/$template/src/"
    echo "  builds/$agency/workspace/$template/out/" 
    echo "  builds/$agency/workspace/$template/in/"
    echo "  builds/$agency/workspace/$template/docs/"
}

validate_manifest() {
    echo "Validating all manifests..."
    
    # Check global registry
    local registry="$PROJECT_ROOT/.coga/registry/agencies.json"
    if [[ -f "$registry" ]]; then
        echo "✓ Global registry found: $registry"
    else
        echo "✗ Global registry missing: $registry"
    fi
    
    # Check agency manifests (ensure they live under builds/<agency>/manifests/manifest.json)
    for agency_dir in "$PROJECT_ROOT/builds"/*; do
        if [[ -d "$agency_dir" ]]; then
            local agency=$(basename "$agency_dir")
            local manifests_dir="$agency_dir/manifests"
            local manifest="$manifests_dir/manifest.json"
            local legacy_manifest="$agency_dir/manifest.json"

            if [[ -f "$manifest" ]]; then
                echo "✓ Agency manifest found: $agency -> $manifest"
            elif [[ -f "$legacy_manifest" ]]; then
                echo "! Legacy manifest found for $agency at $legacy_manifest; migrating to $manifest"
                mkdir -p "$manifests_dir"
                mv "$legacy_manifest" "$manifest"
                echo "✓ Migrated: $manifest"
            else
                echo "✗ Agency manifest missing: $agency -> $manifest"
            fi
        fi
    done
}

list_templates() {
    echo "Template Registry:"
    echo "=================="
    
    for agency_dir in "$PROJECT_ROOT/builds"/*; do
        if [[ -d "$agency_dir" ]]; then
            local agency=$(basename "$agency_dir")
            echo ""
            echo "Agency: $agency"
            echo "-------"
            
            # List workspace templates
            if [[ -d "$agency_dir/workspace" ]]; then
                echo "Workspace Templates:"
                for template_dir in "$agency_dir/workspace"/*; do
                    if [[ -d "$template_dir" ]]; then
                        local template_name=$(basename "$template_dir")
                        echo "  - $template_name"
                        
                        # Check for source files
                        if [[ -d "$template_dir/src" ]]; then
                            find "$template_dir/src" -name "*.xltx" -o -name "*.dotx" -o -name "*.dotm" | while read -r file; do
                                echo "    src: $(basename "$file")"
                            done
                        fi
                        
                        # Check for output files  
                        if [[ -d "$template_dir/out" ]]; then
                            find "$template_dir/out" -name "*.xltx" -o -name "*.dotx" -o -name "*.dotm" | while read -r file; do
                                echo "    out: $(basename "$file")"
                            done
                        fi
                    fi
                done
            fi
            
            # List document templates
            if [[ -d "$agency_dir/templates" ]]; then
                echo "Document Templates:"
                for template_dir in "$agency_dir/templates"/*; do
                    if [[ -d "$template_dir" ]]; then
                        local template_name=$(basename "$template_dir")
                        echo "  - $template_name"
                    fi
                done
            fi
        fi
    done
}

show_help() {
    echo "Usage: manifest <action> <resource> [options]"
    echo ""
    echo "Actions:"
    echo "  generate <core|partials|agency>    - Generate specified manifest (use 'agency <name>' for agency)"
    echo "  validate                           - Validate manifest files and registry"
    echo "  list                               - List templates across builds/"
    echo "  update status <agency> <template> <status> - Update template status"
    echo "  add template <agency> <template> <type>    - Guide for adding new template"
    echo "  help, --help, -h                   - Show this help message"
    echo ""
    echo "Examples:"
    echo "  manifest generate core    (or: manifest-generate-core)"
    echo "  manifest generate partials --dry-run  (or: manifest-generate-partials-builds --dry-run)"
    echo "  manifest generate agency jbc  (or: manifest-generate jbc)"
    echo "  manifest validate"
    echo "  manifest list"
}

case "$1" in
    help|--help|-h)
        show_help
        ;;
    manifest-*)
        # Support hyphenated command aliases: manifest-foo-bar -> manifest foo bar
        # Convert 'manifest-foo-bar ...' -> 'foo bar ...' and re-exec this script
        cmd="${1#manifest-}"
        IFS='-' read -r -a parts <<< "$cmd"
        exec "$SCRIPT_DIR/manifest" "${parts[@]}" "${@:2}"
        ;;
    # New style: manifest <action> <resource> ...
    generate)
        # manifest generate <resource> [...]
        # If no resource specified, generate everything
        if [[ -z "$2" ]]; then
            generate_all
            exit $?
        fi

        case "$2" in
            core)
                generate_manifest core
                ;;
            partials)
                # manifest generate partials [scope]
                # scope may be 'core' to generate core partials; otherwise generate builds-level partials
                if [[ "$3" == "core" ]]; then
                    python3 "$(dirname "${BASH_SOURCE[0]}")/manifest-generate-core-partials.py" "${@:4}"
                else
                    python3 "$(dirname "${BASH_SOURCE[0]}")/manifest-generate-partials.py" "${@:3}"
                fi
                ;;
            agency)
                # manifest generate agency <agency>
                generate_manifest "$3"
                ;;
            *)
                show_help
                ;;
        esac
        ;;
    validate)
        validate_manifest
        ;;
    list)
        list_templates
        ;;
    update)
        # manifest update status <agency> <template> <status>
        if [[ "$2" == "status" ]]; then
            update_template_status "$3" "$4" "$5"
        else
            show_help
        fi
        ;;
    add)
        # manifest add template <agency> <template> <type>
        if [[ "$2" == "template" ]]; then
            add_new_template "$3" "$4" "$5"
        else
            show_help
        fi
        ;;
esac

