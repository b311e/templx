#!/usr/bin/env bash
# Manifest Generator for COGA Template Manager
# Usage: manifest generate [agency] | manifest validate | manifest list

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"

generate_manifest() {
    local agency="$1"
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    if [[ "$agency" == "core" ]]; then
        generate_core_manifest
        return $?
    fi
    
    if [[ -z "$agency" ]]; then
        echo "Usage: manifest generate <agency>"
        echo "Available agencies: jbc, sen, core"
        return 1
    fi
    
    local agency_dir="$PROJECT_ROOT/builds/$agency"
    local manifest_file="$agency_dir/manifest.json"
    
    if [[ ! -d "$agency_dir" ]]; then
        echo "Error: Agency directory not found: $agency_dir"
        return 1
    fi
    
    echo "Generating manifest for agency: $agency"
    echo "Scanning directory: $agency_dir"
    echo "Updating timestamp: $timestamp"
    
    # Update the generated timestamp in existing manifest
    if [[ -f "$manifest_file" ]]; then
        # Use sed to update the timestamp
        sed -i "s/\"generated\": \"[^\"]*\"/\"generated\": \"$timestamp\"/" "$manifest_file"
        echo "✓ Updated timestamp in existing manifest"
    else
        echo "✗ Manifest file not found: $manifest_file"
        echo "   Create one manually or copy from another agency"
        return 1
    fi
    
    # Scan for templates and report findings
    echo ""
    echo "Template Discovery:"
    find "$agency_dir" -name "*.xltx" -o -name "*.dotx" -o -name "*.dotm" | while read -r template; do
        local rel_path="${template#$PROJECT_ROOT/}"
        echo "  Found: $rel_path"
    done
    
    echo ""
    echo " Manifest updated: $manifest_file"
    echo "  Manual updates may be needed for new templates"
}

generate_core_manifest() {
    local core_dir="$PROJECT_ROOT/core"
    local manifest_file="$core_dir/manifest.json"
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    if [[ ! -d "$core_dir" ]]; then
        echo "Error: Core directory not found: $core_dir"
        return 1
    fi
    
    echo "Generating core manifest"
    echo "Scanning directory: $core_dir"
    echo "Manifest file: $manifest_file"
    
    # Initialize category arrays
    local base_normal=()
    local base_theme=()
    local base_sheet=()
    local base_book=()
    local base_colors=()
    local base_fonts=()
    local base_officeUI=()
    local partials_styles=()
    local partials_numbering=()
    
    # Collect all XML files in core/
    while IFS= read -r -d '' file; do
        local rel_path="${file#$PROJECT_ROOT/}"
        local filename=$(basename "$file" .xml)
        local category=""
        local subcategory=""
        
        # Map path to category.subcategory
        if [[ "$rel_path" == core/base/workspace/normal/* ]]; then
            category="base"
            subcategory="normal"
        elif [[ "$rel_path" == core/base/workspace/theme/* ]]; then
            category="base"
            subcategory="theme"
        elif [[ "$rel_path" == core/base/workspace/sheet/* ]]; then
            category="base"
            subcategory="sheet"
        elif [[ "$rel_path" == core/base/workspace/book/* ]]; then
            category="base"
            subcategory="book"
        elif [[ "$rel_path" == core/base/workspace/colors/* ]]; then
            category="base"
            subcategory="colors"
        elif [[ "$rel_path" == core/base/workspace/fonts/* ]]; then
            category="base"
            subcategory="fonts"
        elif [[ "$rel_path" == core/base/workspace/officeUI/* ]]; then
            category="base"
            subcategory="officeUI"
        elif [[ "$rel_path" == core/partials/styles/* ]]; then
            category="partials"
            subcategory="styles"
        elif [[ "$rel_path" == core/partials/numbering/* ]]; then
            category="partials"
            subcategory="numbering"
        else
            # Skip unknown paths
            continue
        fi
        
        local component="{\"id\": \"$filename\", \"path\": \"$rel_path\", \"status\": \"active\"}"
        
        # Add to appropriate array
        case "$category.$subcategory" in
            base.normal) base_normal+=("$component") ;;
            base.theme) base_theme+=("$component") ;;
            base.sheet) base_sheet+=("$component") ;;
            base.book) base_book+=("$component") ;;
            base.colors) base_colors+=("$component") ;;
            base.fonts) base_fonts+=("$component") ;;
            base.officeUI) base_officeUI+=("$component") ;;
            partials.styles) partials_styles+=("$component") ;;
            partials.numbering) partials_numbering+=("$component") ;;
        esac
    done < <(find "$core_dir" -name "*.xml" -print0)
    
    # Function to build JSON array from array
    build_array() {
        local arr=("$@")
        local json=""
        local first=true
        for item in "${arr[@]}"; do
            if $first; then
                first=false
            else
                json+=",\n        "
            fi
            json+="$item"
        done
        echo -e "$json"
    }
    
    # Build JSON
    local json="{\n  \"generated\": \"$timestamp\",\n  \"core\": {\n    \"base\": {\n"
    json+="      \"normal\": [\n        $(build_array "${base_normal[@]}")\n      ],\n"
    json+="      \"theme\": [\n        $(build_array "${base_theme[@]}")\n      ],\n"
    json+="      \"sheet\": [\n        $(build_array "${base_sheet[@]}")\n      ],\n"
    json+="      \"book\": [\n        $(build_array "${base_book[@]}")\n      ],\n"
    json+="      \"colors\": [\n        $(build_array "${base_colors[@]}")\n      ],\n"
    json+="      \"fonts\": [\n        $(build_array "${base_fonts[@]}")\n      ],\n"
    json+="      \"officeUI\": [\n        $(build_array "${base_officeUI[@]}")\n      ]\n"
    json+="    },\n    \"partials\": {\n"
    json+="      \"styles\": [\n        $(build_array "${partials_styles[@]}")\n      ],\n"
    json+="      \"numbering\": [\n        $(build_array "${partials_numbering[@]}")\n      ]\n"
    json+="    }\n  }\n}"
    
    # Write to file
    echo -e "$json" > "$manifest_file"
    
    local total=$(( ${#base_normal[@]} + ${#base_theme[@]} + ${#base_sheet[@]} + ${#base_book[@]} + ${#base_colors[@]} + ${#base_fonts[@]} + ${#base_officeUI[@]} + ${#partials_styles[@]} + ${#partials_numbering[@]} ))
    echo "✓ Core manifest generated: $manifest_file"
    echo "  Found $total components across categories"
}

update_template_status() {
    local agency="$1"
    local template="$2" 
    local status="$3"
    
    if [[ -z "$agency" || -z "$template" || -z "$status" ]]; then
        echo "Usage: manifest update-status <agency> <template> <status>"
        echo "Status options: active, planned, deprecated, testing"
        return 1
    fi
    
    local manifest_file="$PROJECT_ROOT/builds/$agency/manifest.json"
    
    if [[ ! -f "$manifest_file" ]]; then
        echo "Error: Manifest not found: $manifest_file"
        return 1
    fi
    
    # Create backup
    cp "$manifest_file" "$manifest_file.backup"
    
    # Use sed to update the status
    sed -i "/$template/,/status/s/\"status\": \"[^\"]*\"/\"status\": \"$status\"/" "$manifest_file"
    
    echo "✓ Updated $template status to '$status' in $agency manifest"
    echo "✓ Backup created: $manifest_file.backup"
}

add_new_template() {
    local agency="$1"
    local template="$2"
    local type="$3"
    
    if [[ -z "$agency" || -z "$template" || -z "$type" ]]; then
        echo "Usage: manifest add-template <agency> <template> <type>"
        echo "Types: excel-book-template, excel-sheet-template, word-doc-template"
        return 1
    fi
    
    echo "To add a new template '$template' to agency '$agency':"
    echo "1. Edit builds/$agency/manifest.json"
    echo "2. Add template entry in appropriate category"
    echo "3. Run: manifest generate $agency"
    echo ""
    echo "Template structure needed:"
    echo "  builds/$agency/workspace/$template/src/"
    echo "  builds/$agency/workspace/$template/out/" 
    echo "  builds/$agency/workspace/$template/in/"
    echo "  builds/$agency/workspace/$template/docs/"
}

validate_manifest() {
    echo "Validating all manifests..."
    
    # Check global registry
    local registry="$PROJECT_ROOT/.coga/registry/agencies.json"
    if [[ -f "$registry" ]]; then
        echo "✓ Global registry found: $registry"
    else
        echo "✗ Global registry missing: $registry"
    fi
    
    # Check agency manifests
    for agency_dir in "$PROJECT_ROOT/builds"/*; do
        if [[ -d "$agency_dir" ]]; then
            local agency=$(basename "$agency_dir")
            local manifest="$agency_dir/manifest.json"
            
            if [[ -f "$manifest" ]]; then
                echo "✓ Agency manifest found: $agency -> $manifest"
            else
                echo "✗ Agency manifest missing: $agency -> $manifest"
            fi
        fi
    done
}

list_templates() {
    echo "Template Registry:"
    echo "=================="
    
    for agency_dir in "$PROJECT_ROOT/builds"/*; do
        if [[ -d "$agency_dir" ]]; then
            local agency=$(basename "$agency_dir")
            echo ""
            echo "Agency: $agency"
            echo "-------"
            
            # List workspace templates
            if [[ -d "$agency_dir/workspace" ]]; then
                echo "Workspace Templates:"
                for template_dir in "$agency_dir/workspace"/*; do
                    if [[ -d "$template_dir" ]]; then
                        local template_name=$(basename "$template_dir")
                        echo "  - $template_name"
                        
                        # Check for source files
                        if [[ -d "$template_dir/src" ]]; then
                            find "$template_dir/src" -name "*.xltx" -o -name "*.dotx" -o -name "*.dotm" | while read -r file; do
                                echo "    src: $(basename "$file")"
                            done
                        fi
                        
                        # Check for output files  
                        if [[ -d "$template_dir/out" ]]; then
                            find "$template_dir/out" -name "*.xltx" -o -name "*.dotx" -o -name "*.dotm" | while read -r file; do
                                echo "    out: $(basename "$file")"
                            done
                        fi
                    fi
                done
            fi
            
            # List document templates
            if [[ -d "$agency_dir/templates" ]]; then
                echo "Document Templates:"
                for template_dir in "$agency_dir/templates"/*; do
                    if [[ -d "$template_dir" ]]; then
                        local template_name=$(basename "$template_dir")
                        echo "  - $template_name"
                    fi
                done
            fi
        fi
    done
}

show_help() {
    echo "Usage: manifest-<command> [options]"
    echo ""
    echo "Commands:"
    echo "  help, --help, -h                                    - Show this help message"
    echo "  manifest-generate <agency>                          - Update manifest timestamp and scan for templates"
    echo "  manifest-update <agency>                            - Update manifest for specified agency"
    echo "  manifest-update-status <agency> <template> <status> - Update template status"
    echo "  manifest-add-template <agency> <template> <type>    - Guide for adding new template"
    echo "  manifest-validate                                   - Validate all manifests"
    echo "  manifest-list                                       - List all templates"
    echo ""
    echo "Examples:"
    echo "  manifest-generate jbc"
    echo "  manifest-update core"
    echo "  manifest-update-status jbc jbcNormal active"
    echo "  manifest-add-template jbc jbcReport excel-book-template"
    echo "  manifest-validate"
    echo "  manifest-list"
}

case "$1" in
    help|--help|-h)
        show_help
        ;;
    manifest-generate)
        generate_manifest "$2"
        ;;
    manifest-update)
        # Update manifest for specified agency (supports 'core' for core manifest)
        if [[ "$2" == "core" ]]; then
            generate_core_manifest
        else
            generate_manifest "$2"
        fi
        ;;
    manifest-update-status)
        update_template_status "$2" "$3" "$4"
        ;;
    manifest-add-template)
        add_new_template "$2" "$3" "$4"
        ;;
    manifest-validate)
        validate_manifest
        ;;
    manifest-list)
        list_templates
        ;;
    *)
        show_help
        ;;
esac
