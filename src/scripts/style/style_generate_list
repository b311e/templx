#!/usr/bin/env bash
# List Styles Script (renamed)
# Usage: style_generate_list <templatePath>

set -euo pipefail

if [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]] 2>/dev/null; then
    echo "Usage: style-generate-list <expandedPath>"
    echo ""
    echo "Extract and list all styles from an unpacked Word template"
    echo ""
    echo "Arguments:"
    echo "  expandedPath  - Path to expanded folder (in/ or expanded/)"
    echo "                  Must contain word/styles.xml"
    echo ""
    echo "Output:"
    echo "  Style list saved to docs/style-list-{templateName}.txt in template directory"
    echo ""
    echo "Examples:"
    echo "  style-generate-list builds/jbc/workspace/jbcNormal/in"
    echo "  style-generate-list C:/code/templx/builds/jbc/workspace/jbcNormal/in"
    exit 0
fi

if [ $# -eq 0 ]; then
    echo "Usage: style-generate-list <expandedPath>"
    echo "Run 'style-generate-list --help' for more information"
    exit 1
fi

expanded_path="$1"

# Convert Windows path to Unix path if needed (for Git Bash on Windows)
if [[ "$expanded_path" =~ ^[A-Za-z]:\\ ]]; then
    # Convert C:\path to /c/path format
    drive_letter=$(echo "${expanded_path:0:1}" | tr '[:upper:]' '[:lower:]')
    rest_of_path="${expanded_path:3}"
    rest_of_path="${rest_of_path//\\//}"
    expanded_path="/$drive_letter/$rest_of_path"
elif [[ "$expanded_path" != /* ]]; then
    # Convert to absolute path if relative
    expanded_path="$(pwd)/$expanded_path"
fi

# Check if the expanded directory exists
if [ ! -d "$expanded_path" ]; then
    echo "Error: Expanded directory not found: $expanded_path" >&2
    exit 1
fi

# Look for styles.xml in word/ subdirectory
styles_xml="$expanded_path/word/styles.xml"
if [ ! -f "$styles_xml" ]; then
    echo "Error: styles.xml not found at: $styles_xml" >&2
    echo "Make sure you provide the path to the expanded folder (e.g., .../in or .../expanded)" >&2
    exit 1
fi

# Get template name from parent directory of expanded folder
template_dir=$(dirname "$expanded_path")
template_name=$(basename "$template_dir")

# Create output file in template's docs directory
docs_dir="$template_dir/docs"
mkdir -p "$docs_dir"
output_file="$docs_dir/${template_name}-styles-list.txt"

# Extract styles using Python (more portable than xmlstarlet)
python3 - "${styles_xml}" "${output_file}" << 'PYTHON_SCRIPT'
import xml.etree.ElementTree as ET
import sys

if len(sys.argv) < 3:
    print("Error: Missing arguments", file=sys.stderr)
    sys.exit(1)

styles_xml = sys.argv[1]
output_file = sys.argv[2]

try:
    # Parse the XML file
    tree = ET.parse(styles_xml)
    root = tree.getroot()
    
    # Define namespace
    ns = {'w': 'http://schemas.openxmlformats.org/wordprocessingml/2006/main'}
    
    # Find all style elements
    styles = root.findall('w:style', ns)
    
    # Write to output file
    with open(output_file, 'w', encoding='utf-8') as f:
        for i, style in enumerate(styles, 1):
            style_id = style.get('{http://schemas.openxmlformats.org/wordprocessingml/2006/main}styleId', 'N/A')
            name_elem = style.find('w:name', ns)
            name_val = name_elem.get('{http://schemas.openxmlformats.org/wordprocessingml/2006/main}val', 'N/A') if name_elem is not None else 'N/A'
            f.write(f'{i}: {style_id} â€” {name_val}\n')
    
    print(f'Wrote {len(styles)} styles to {output_file}')
except Exception as e:
    print(f"Error: {e}", file=sys.stderr)
    sys.exit(1)
PYTHON_SCRIPT

if [ $? -ne 0 ]; then
    echo "Error: Failed to extract styles. Python 3 is required." >&2
    exit 1
fi
