#!/usr/bin/env python3
"""
style_import_partial - import styles from a single snippet into a target styles.xml

Usage: style_import_partial <target-styles-xml> <snippet-xml> [--dry-run] [--backup]

This replaces styles in the target with those from the snippet (matching by styleId).
"""
import argparse
import os
import shutil
import xml.etree.ElementTree as ET
from copy import deepcopy

# Preserve Word namespaces
ET.register_namespace('w', 'http://schemas.openxmlformats.org/wordprocessingml/2006/main')
ET.register_namespace('mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006')
ET.register_namespace('r', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships')

NS_W = '{http://schemas.openxmlformats.org/wordprocessingml/2006/main}'

def extract_styles_from_file(path):
    if not os.path.exists(path):
        return []
    try:
        tree = ET.parse(path)
        root = tree.getroot()
    except Exception:
        return []
    styles = []
    for style in root.findall('.//' + NS_W + 'style'):
        sid = style.get(NS_W + 'styleId')
        styles.append((sid, style))
    return styles

def main():
    parser = argparse.ArgumentParser(prog='style_import_partial')
    parser.add_argument('target', help='target styles.xml to modify')
    parser.add_argument('snippet', help='snippet XML containing <w:style> elements')
    parser.add_argument('--dry-run', action='store_true')
    parser.add_argument('--backup', action='store_true', help='Create a .bak backup before writing')
    args = parser.parse_args()

    target = args.target
    snippet = args.snippet

    styles = extract_styles_from_file(snippet)
    if not styles:
        print('No styles found in snippet:', snippet)
        return 2

    if args.dry_run:
        print('Dry run: will import the following styles from', snippet)
        for sid, _ in styles:
            print(' ', sid)
        return 0

    if not os.path.exists(target):
        print('Target styles.xml not found:', target)
        return 2

    backup_path = target + '.bak'
    backup_created = False
    if args.backup:
        shutil.copyfile(target, backup_path)
        backup_created = True

    tree = ET.parse(target)
    root = tree.getroot()

    # Build dict of existing styles by id (lowercased)
    existing = {}
    for s in root.findall('.//' + NS_W + 'style'):
        sid = (s.get(NS_W + 'styleId') or '').lower()
        if sid:
            existing[sid] = s

    # Replace or append styles from snippet
    for sid, elem in styles:
        if not sid:
            continue
        key = sid.lower()
        if key in existing:
            parent = root
            try:
                parent.remove(existing[key])
            except Exception:
                pass
        # append a deep copy of the element into target root
        root.append(deepcopy(elem))

    tree.write(target, encoding='utf-8', xml_declaration=True)
    # Always report the write; include backup info only if created.
    if backup_created:
        print('Wrote', target, '(backup at', backup_path + ')')
    else:
        print('Wrote', target)
    return 0

if __name__ == '__main__':
    raise SystemExit(main())
