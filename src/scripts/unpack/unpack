#!/usr/bin/env bash
# OpenXML Unpack Alias
# Usage: unpack [file path]

set -euo pipefail

# Convert Windows path to Unix path if needed (for Git Bash on Windows)
normalize_path() {
    local path="$1"
    if [[ "$path" =~ ^[A-Za-z]:\\ ]]; then
        # Convert C:\path to /c/path format
        local drive_letter=$(echo "${path:0:1}" | tr '[:upper:]' '[:lower:]')
        local rest_of_path="${path:3}"
        rest_of_path="${rest_of_path//\\//}"
        echo "/$drive_letter/$rest_of_path"
    else
        echo "$path"
    fi
}

if [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]] 2>/dev/null; then
    echo "Usage: unpack <file path>"
    echo ""
    echo "Unpack OpenXML templates/documents into expanded folder structure"
    echo ""
    echo "Arguments:"
    echo "  file path  - Path to .dotx, .dotm, .xltx, .xltm, etc. file"
    echo ""
    echo "Examples:"
    echo "  unpack builds/jbc/workspace/jbcNormal/src/Normal.dotm"
    echo "  unpack builds/jbc/templates/jbcMemo/src/Memo.dotx"
    exit 0
fi

if [ $# -eq 0 ]; then
    echo "Usage: unpack [file path]"
    echo "Run 'unpack --help' for more information"
    exit 1
fi

# Get the script directory to find the project
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# PROJECT_ROOT should point to the repository root. The unpack script lives at:
#   <repo>/src/scripts/unpack/unpack
# so we need to go up three levels to reach the repo root.
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"

# Run the dotnet command from the project file. Use "--" to ensure any
# subsequent arguments are forwarded to the application (not to dotnet).
dotnet run --project "$PROJECT_ROOT/src/OpenXmlApp/OpenXmlApp.csproj" -- unpack "$@"
